import{_ as n,c as a,d as p,o as t}from"./app-DDoPRsSr.js";const e={};function c(l,s){return t(),a("div",null,[...s[0]||(s[0]=[p(`<h1 id="pytorch的batchsampler的一个优化技巧" tabindex="-1"><a class="header-anchor" href="#pytorch的batchsampler的一个优化技巧"><span>PyTorch的BatchSampler的一个优化技巧</span></a></h1><p>最近在阅读PyTorch的源码的时候，发现<code>torch.utils.data.sampler.BatchSampler</code>的实现非常有意思：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Iterator<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># Implemented based on the benchmarking in https://github.com/pytorch/pytorch/pull/76951</span></span>
<span class="line">        sampler_iter <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>drop_last<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># Create multiple references to the same iterator</span></span>
<span class="line">            args <span class="token operator">=</span> <span class="token punctuation">[</span>sampler_iter<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>batch_size</span>
<span class="line">            <span class="token keyword">for</span> batch_droplast <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">yield</span> <span class="token punctuation">[</span><span class="token operator">*</span>batch_droplast<span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span>itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>sampler_iter<span class="token punctuation">,</span> self<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token keyword">while</span> batch<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">yield</span> batch</span>
<span class="line">                batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span>itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>sampler_iter<span class="token punctuation">,</span> self<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码运用了<code>zip</code>和<code>itertools.islice</code>来实现批量采样的功能。我将其中的核心思想提取出来，写了一个简单的benchmark：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> time</span>
<span class="line"><span class="token keyword">import</span> itertools</span>
<span class="line"></span>
<span class="line">sampler <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">320000</span><span class="token punctuation">)</span></span>
<span class="line">batch_size <span class="token operator">=</span> <span class="token number">32</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">batch_iter_naive</span><span class="token punctuation">(</span>sampler<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> sampler<span class="token punctuation">:</span></span>
<span class="line">        batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span> <span class="token operator">==</span> batch_size<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">yield</span> batch</span>
<span class="line">            batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">batch_iter_faster_1</span><span class="token punctuation">(</span>sampler<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    sampler_iter <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>sampler<span class="token punctuation">)</span></span>
<span class="line">    iters <span class="token operator">=</span> <span class="token punctuation">[</span>sampler_iter<span class="token punctuation">]</span> <span class="token operator">*</span> batch_size</span>
<span class="line">    <span class="token keyword">for</span> batch <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>iters<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">yield</span> <span class="token builtin">list</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">batch_iter_faster_2</span><span class="token punctuation">(</span>sampler<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    sampler_iter <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>sampler<span class="token punctuation">)</span></span>
<span class="line">    batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span>itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>sampler_iter<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">while</span> batch<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">yield</span> batch</span>
<span class="line">        batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span>itertools<span class="token punctuation">.</span>islice<span class="token punctuation">(</span>sampler_iter<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token builtin">list</span><span class="token punctuation">(</span>batch_iter_naive<span class="token punctuation">(</span>sampler<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Naive method time:&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token builtin">list</span><span class="token punctuation">(</span>batch_iter_faster_1<span class="token punctuation">(</span>sampler<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Faster method 1 time:&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token builtin">list</span><span class="token punctuation">(</span>batch_iter_faster_2<span class="token punctuation">(</span>sampler<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Faster method 2 time:&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果发现改进后的方法确实比普通方法快了不少。</p><p>至于速度变快的原因，我猜测是因为Python的for循环迭代开销太大，而<code>zip</code>和<code>itertools.islice</code>都是C实现的，迭代速度更快。从中可以总结出一个Python优化的技巧：用C实现的函数减少for循环的次数。</p>`,7)])])}const i=n(e,[["render",c]]),u=JSON.parse('{"path":"/posts/pytorch-batch-trick.html","title":"PyTorch的BatchSampler的一个优化技巧","lang":"zh-CN","frontmatter":{"date":"2025-04-29T00:00:00.000Z"},"headers":[],"git":{"updatedTime":1763698804000,"contributors":[{"name":"shi0rik0","username":"shi0rik0","email":"anguuan@outlook.com","commits":1,"url":"https://github.com/shi0rik0"}],"changelog":[{"hash":"27621ea60c6645dc9e44007e7ab6fd2858c37eaf","time":1763698804000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Migrate posts"}]},"filePathRelative":"posts/pytorch-batch-trick.md","excerpt":"\\n<p>最近在阅读PyTorch的源码的时候，发现<code>torch.utils.data.sampler.BatchSampler</code>的实现非常有意思：</p>\\n<div class=\\"language-python line-numbers-mode\\" data-highlighter=\\"prismjs\\" data-ext=\\"py\\"><pre><code><span class=\\"line\\">    <span class=\\"token keyword\\">def</span> <span class=\\"token function\\">__iter__</span><span class=\\"token punctuation\\">(</span>self<span class=\\"token punctuation\\">)</span> <span class=\\"token operator\\">-</span><span class=\\"token operator\\">&gt;</span> Iterator<span class=\\"token punctuation\\">[</span>List<span class=\\"token punctuation\\">[</span><span class=\\"token builtin\\">int</span><span class=\\"token punctuation\\">]</span><span class=\\"token punctuation\\">]</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">        <span class=\\"token comment\\"># Implemented based on the benchmarking in https://github.com/pytorch/pytorch/pull/76951</span></span>\\n<span class=\\"line\\">        sampler_iter <span class=\\"token operator\\">=</span> <span class=\\"token builtin\\">iter</span><span class=\\"token punctuation\\">(</span>self<span class=\\"token punctuation\\">.</span>sampler<span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\">        <span class=\\"token keyword\\">if</span> self<span class=\\"token punctuation\\">.</span>drop_last<span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">            <span class=\\"token comment\\"># Create multiple references to the same iterator</span></span>\\n<span class=\\"line\\">            args <span class=\\"token operator\\">=</span> <span class=\\"token punctuation\\">[</span>sampler_iter<span class=\\"token punctuation\\">]</span> <span class=\\"token operator\\">*</span> self<span class=\\"token punctuation\\">.</span>batch_size</span>\\n<span class=\\"line\\">            <span class=\\"token keyword\\">for</span> batch_droplast <span class=\\"token keyword\\">in</span> <span class=\\"token builtin\\">zip</span><span class=\\"token punctuation\\">(</span><span class=\\"token operator\\">*</span>args<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">                <span class=\\"token keyword\\">yield</span> <span class=\\"token punctuation\\">[</span><span class=\\"token operator\\">*</span>batch_droplast<span class=\\"token punctuation\\">]</span></span>\\n<span class=\\"line\\">        <span class=\\"token keyword\\">else</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">            batch <span class=\\"token operator\\">=</span> <span class=\\"token punctuation\\">[</span><span class=\\"token operator\\">*</span>itertools<span class=\\"token punctuation\\">.</span>islice<span class=\\"token punctuation\\">(</span>sampler_iter<span class=\\"token punctuation\\">,</span> self<span class=\\"token punctuation\\">.</span>batch_size<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">]</span></span>\\n<span class=\\"line\\">            <span class=\\"token keyword\\">while</span> batch<span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">                <span class=\\"token keyword\\">yield</span> batch</span>\\n<span class=\\"line\\">                batch <span class=\\"token operator\\">=</span> <span class=\\"token punctuation\\">[</span><span class=\\"token operator\\">*</span>itertools<span class=\\"token punctuation\\">.</span>islice<span class=\\"token punctuation\\">(</span>sampler_iter<span class=\\"token punctuation\\">,</span> self<span class=\\"token punctuation\\">.</span>batch_size<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">]</span></span>\\n<span class=\\"line\\"></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}');export{i as comp,u as data};
