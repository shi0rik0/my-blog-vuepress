import{_ as s,c as a,d as p,o as e}from"./app-DDoPRsSr.js";const t={};function i(c,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h1 id="在python中实现一个简易的协程" tabindex="-1"><a class="header-anchor" href="#在python中实现一个简易的协程"><span>在Python中实现一个简易的协程</span></a></h1><h2 id="基本概念" tabindex="-1"><a class="header-anchor" href="#基本概念"><span>基本概念</span></a></h2><p>在Python的协程体系中有两个基本概念：coroutine和coroutine function。</p><p>coroutine对象拥有一个<code>__await__</code>函数，调用这个函数会返回一个生成器。而调用一个coroutine function则会返回一个coroutine对象。</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> asyncio</span>
<span class="line"><span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Generator</span>
<span class="line"></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">pass</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 都会返回 True</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>iscoroutinefunction<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>iscoroutine<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__await__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Generator<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样我们就明白Python协程的工作原理了。当我们await一个协程对象的时候，实际上是调用了这个对象的<code>__await__</code>方法，得到一个生成器对象。这个生成器对象会被调度器调度执行。协程通过<code>yield</code>语句来暂停执行，将控制权交还给调度器。</p><h2 id="实现一个简单的协程" tabindex="-1"><a class="header-anchor" href="#实现一个简单的协程"><span>实现一个简单的协程</span></a></h2><p>要实现一个简单的协程，只需要定义一个能返回生成器的的<code>__await__</code>方法，即可，下面是一个简单的例子：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> asyncio</span>
<span class="line"><span class="token keyword">import</span> time</span>
<span class="line"><span class="token keyword">import</span> logging</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span></span>
<span class="line">    level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span></span>
<span class="line">    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">&quot;[%(asctime)s.%(msecs)03d] %(message)s&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    datefmt<span class="token operator">=</span><span class="token string">&quot;%H:%M:%S&quot;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyAsyncSleep</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>seconds <span class="token operator">=</span> seconds</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__await__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">while</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>seconds<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">yield</span></span>
<span class="line">        logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Slept for </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>seconds<span class="token punctuation">}</span></span><span class="token string"> seconds&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Starting sleep...&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span></span>
<span class="line">        MyAsyncSleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        MyAsyncSleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        MyAsyncSleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;Finished sleep!&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span></span>
<span class="line">    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h2><p><a href="https://aureliano90.github.io/blog/2022/04/28/A_Brief_Introduction_of_Python_Coroutines_and__await__Attribute.html" target="_blank" rel="noopener noreferrer">浅谈Python协程与__await__属性</a></p>`,11)])])}const l=s(t,[["render",i]]),u=JSON.parse('{"path":"/posts/python-implement-coroutine.html","title":"在Python中实现一个简易的协程","lang":"zh-CN","frontmatter":{"date":"2025-05-12T00:00:00.000Z"},"headers":[{"level":2,"title":"基本概念","slug":"基本概念","link":"#基本概念","children":[]},{"level":2,"title":"实现一个简单的协程","slug":"实现一个简单的协程","link":"#实现一个简单的协程","children":[]},{"level":2,"title":"参考资料","slug":"参考资料","link":"#参考资料","children":[]}],"git":{"updatedTime":1763698804000,"contributors":[{"name":"shi0rik0","username":"shi0rik0","email":"anguuan@outlook.com","commits":1,"url":"https://github.com/shi0rik0"}],"changelog":[{"hash":"27621ea60c6645dc9e44007e7ab6fd2858c37eaf","time":1763698804000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Migrate posts"}]},"filePathRelative":"posts/python-implement-coroutine.md","excerpt":"\\n<h2>基本概念</h2>\\n<p>在Python的协程体系中有两个基本概念：coroutine和coroutine function。</p>\\n<p>coroutine对象拥有一个<code>__await__</code>函数，调用这个函数会返回一个生成器。而调用一个coroutine function则会返回一个coroutine对象。</p>\\n<div class=\\"language-python line-numbers-mode\\" data-highlighter=\\"prismjs\\" data-ext=\\"py\\"><pre><code><span class=\\"line\\"><span class=\\"token keyword\\">import</span> asyncio</span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">from</span> collections<span class=\\"token punctuation\\">.</span>abc <span class=\\"token keyword\\">import</span> Generator</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">async</span> <span class=\\"token keyword\\">def</span> <span class=\\"token function\\">f</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">    <span class=\\"token keyword\\">pass</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span class=\\"token comment\\"># 都会返回 True</span></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">print</span><span class=\\"token punctuation\\">(</span>asyncio<span class=\\"token punctuation\\">.</span>iscoroutinefunction<span class=\\"token punctuation\\">(</span>f<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">print</span><span class=\\"token punctuation\\">(</span>asyncio<span class=\\"token punctuation\\">.</span>iscoroutine<span class=\\"token punctuation\\">(</span>f<span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">print</span><span class=\\"token punctuation\\">(</span><span class=\\"token builtin\\">isinstance</span><span class=\\"token punctuation\\">(</span>f<span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span>__await__<span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">,</span> Generator<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\"></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}');export{l as comp,u as data};
