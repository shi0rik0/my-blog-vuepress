import{_ as s,c as a,d as p,o as e}from"./app-D9VVartN.js";const t={};function o(c,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h1 id="在python中用进程池异步执行任务" tabindex="-1"><a class="header-anchor" href="#在python中用进程池异步执行任务"><span>在Python中用进程池异步执行任务</span></a></h1><p>废话不多说，先直接上代码：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> asyncio</span>
<span class="line"><span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ProcessPoolExecutor</span>
<span class="line"><span class="token keyword">import</span> multiprocessing</span>
<span class="line"><span class="token keyword">import</span> os</span>
<span class="line"></span>
<span class="line">var_per_process <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">initialize_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">global</span> var_per_process</span>
<span class="line">    var_per_process <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Process </span><span class="token interpolation"><span class="token punctuation">{</span>var_per_process<span class="token punctuation">}</span></span><span class="token string"> received </span><span class="token interpolation"><span class="token punctuation">{</span>arg1<span class="token punctuation">}</span></span><span class="token string"> and </span><span class="token interpolation"><span class="token punctuation">{</span>arg2<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> arg1 <span class="token operator">+</span> arg2</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">with</span> ProcessPoolExecutor<span class="token punctuation">(</span></span>
<span class="line">        max_workers<span class="token operator">=</span>multiprocessing<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initializer<span class="token operator">=</span>initialize_process</span>
<span class="line">    <span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span></span>
<span class="line">        inputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">        results <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">*</span><span class="token punctuation">[</span>loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span>executor<span class="token punctuation">,</span> add<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token keyword">in</span> inputs<span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span></span>
<span class="line">    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ProcessPoolExecutor</code>的构造函数有一个<code>initializer</code>参数，可以传入一个函数，这个函数会在每个进程启动的时候被调用。这个函数可以用来初始化每个进程的状态，比如连接数据库等。</p><p><code>loop.run_in_executor</code>的返回值是一个<code>Future</code>对象。将多个<code>Future</code>对象传入<code>asyncio.gather</code>，就可以异步执行多个任务，并等待所有任务完成。</p><p>执行这段代码，会看到类似下面的输出：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Process 4088441 received 1 and 2</span>
<span class="line">Process 4088442 received 3 and 4</span>
<span class="line">Process 4088443 received 5 and 6</span>
<span class="line">[3, 7, 11]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,7)])])}const l=s(t,[["render",o]]),u=JSON.parse('{"path":"/posts/2025/03/python-process-pool-async.html","title":"在Python中用进程池异步执行任务","lang":"zh-CN","frontmatter":{"date":"2025-03-25T00:00:00.000Z"},"headers":[],"git":{"updatedTime":1763699399000,"contributors":[{"name":"shi0rik0","username":"shi0rik0","email":"anguuan@outlook.com","commits":2,"url":"https://github.com/shi0rik0"}],"changelog":[{"hash":"35d50711ef3a591a2383977aa02873c707aa5c1e","time":1763699399000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Organize files by date"},{"hash":"27621ea60c6645dc9e44007e7ab6fd2858c37eaf","time":1763698804000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Migrate posts"}]},"filePathRelative":"posts/2025/03/python-process-pool-async.md","excerpt":"\\n<p>废话不多说，先直接上代码：</p>\\n<div class=\\"language-python line-numbers-mode\\" data-highlighter=\\"prismjs\\" data-ext=\\"py\\"><pre><code><span class=\\"line\\"><span class=\\"token keyword\\">import</span> asyncio</span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">from</span> concurrent<span class=\\"token punctuation\\">.</span>futures <span class=\\"token keyword\\">import</span> ProcessPoolExecutor</span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">import</span> multiprocessing</span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">import</span> os</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">var_per_process <span class=\\"token operator\\">=</span> <span class=\\"token boolean\\">None</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">def</span> <span class=\\"token function\\">initialize_process</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">    <span class=\\"token keyword\\">global</span> var_per_process</span>\\n<span class=\\"line\\">    var_per_process <span class=\\"token operator\\">=</span> os<span class=\\"token punctuation\\">.</span>getpid<span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">def</span> <span class=\\"token function\\">add</span><span class=\\"token punctuation\\">(</span>arg1<span class=\\"token punctuation\\">,</span> arg2<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">    <span class=\\"token keyword\\">print</span><span class=\\"token punctuation\\">(</span><span class=\\"token string-interpolation\\"><span class=\\"token string\\">f\\"Process </span><span class=\\"token interpolation\\"><span class=\\"token punctuation\\">{</span>var_per_process<span class=\\"token punctuation\\">}</span></span><span class=\\"token string\\"> received </span><span class=\\"token interpolation\\"><span class=\\"token punctuation\\">{</span>arg1<span class=\\"token punctuation\\">}</span></span><span class=\\"token string\\"> and </span><span class=\\"token interpolation\\"><span class=\\"token punctuation\\">{</span>arg2<span class=\\"token punctuation\\">}</span></span><span class=\\"token string\\">\\"</span></span><span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\">    <span class=\\"token keyword\\">return</span> arg1 <span class=\\"token operator\\">+</span> arg2</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">async</span> <span class=\\"token keyword\\">def</span> <span class=\\"token function\\">main</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">    loop <span class=\\"token operator\\">=</span> asyncio<span class=\\"token punctuation\\">.</span>get_event_loop<span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\">    <span class=\\"token keyword\\">with</span> ProcessPoolExecutor<span class=\\"token punctuation\\">(</span></span>\\n<span class=\\"line\\">        max_workers<span class=\\"token operator\\">=</span>multiprocessing<span class=\\"token punctuation\\">.</span>cpu_count<span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">,</span> initializer<span class=\\"token operator\\">=</span>initialize_process</span>\\n<span class=\\"line\\">    <span class=\\"token punctuation\\">)</span> <span class=\\"token keyword\\">as</span> executor<span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">        inputs <span class=\\"token operator\\">=</span> <span class=\\"token punctuation\\">[</span><span class=\\"token punctuation\\">(</span><span class=\\"token number\\">1</span><span class=\\"token punctuation\\">,</span> <span class=\\"token number\\">2</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">,</span> <span class=\\"token punctuation\\">(</span><span class=\\"token number\\">3</span><span class=\\"token punctuation\\">,</span> <span class=\\"token number\\">4</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">,</span> <span class=\\"token punctuation\\">(</span><span class=\\"token number\\">5</span><span class=\\"token punctuation\\">,</span> <span class=\\"token number\\">6</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">]</span></span>\\n<span class=\\"line\\">        results <span class=\\"token operator\\">=</span> <span class=\\"token keyword\\">await</span> asyncio<span class=\\"token punctuation\\">.</span>gather<span class=\\"token punctuation\\">(</span></span>\\n<span class=\\"line\\">            <span class=\\"token operator\\">*</span><span class=\\"token punctuation\\">[</span>loop<span class=\\"token punctuation\\">.</span>run_in_executor<span class=\\"token punctuation\\">(</span>executor<span class=\\"token punctuation\\">,</span> add<span class=\\"token punctuation\\">,</span> i<span class=\\"token punctuation\\">,</span> j<span class=\\"token punctuation\\">)</span> <span class=\\"token keyword\\">for</span> i<span class=\\"token punctuation\\">,</span> j <span class=\\"token keyword\\">in</span> inputs<span class=\\"token punctuation\\">]</span></span>\\n<span class=\\"line\\">        <span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\">        <span class=\\"token keyword\\">print</span><span class=\\"token punctuation\\">(</span>results<span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">if</span> __name__ <span class=\\"token operator\\">==</span> <span class=\\"token string\\">\\"__main__\\"</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">    asyncio<span class=\\"token punctuation\\">.</span>run<span class=\\"token punctuation\\">(</span>main<span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span></span>\\n<span class=\\"line\\"></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}');export{l as comp,u as data};
