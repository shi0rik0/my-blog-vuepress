import{_ as e,c as n,d as a,o as t}from"./app-D9VVartN.js";const i={};function l(p,s){return t(),n("div",null,[...s[0]||(s[0]=[a(`<h1 id="windows-ntp指南" tabindex="-1"><a class="header-anchor" href="#windows-ntp指南"><span>Windows NTP指南</span></a></h1><p>本文将介绍如何在 Windows 系统上启动 NTP 服务器，以及如何让 NTP 客户端同步时间。</p><p>注意：本文中的大部分操作都需要管理员权限。</p><h2 id="防火墙配置" tabindex="-1"><a class="header-anchor" href="#防火墙配置"><span>防火墙配置</span></a></h2><p>默认配置下，Windows 防火墙会阻止所有未经允许的入站连接。因此，我们需要允许 NTP 服务（使用 UDP 123 端口）的入站连接。</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token function">New-NetFirewallRule</span> <span class="token operator">-</span>DisplayName <span class="token string">&quot;Allow NTP&quot;</span> <span class="token operator">-</span>Direction Inbound <span class="token operator">-</span>Protocol UDP <span class="token operator">-</span>LocalPort 123 <span class="token operator">-</span>Action Allow</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="启动-ntp-服务器" tabindex="-1"><a class="header-anchor" href="#启动-ntp-服务器"><span>启动 NTP 服务器</span></a></h2><p>默认配置下，Windows 的 NTP 服务（<code>w32time</code>）是禁用服务器功能的，我们需要手动修改注册表，然后重启服务来开启：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token function">Set-ItemProperty</span> <span class="token operator">-</span>Path <span class="token string">&quot;HKLM:\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\NtpServer&quot;</span> <span class="token operator">-</span>Name <span class="token string">&quot;Enabled&quot;</span> <span class="token operator">-</span>Value 1</span>
<span class="line"><span class="token function">Restart-Service</span> w32time</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后运行下面的命令让<code>w23time</code>开机自动启动，并查看其状态：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token function">Set-Service</span> w32time <span class="token operator">-</span>StartupType Automatic</span>
<span class="line"><span class="token function">Get-Service</span> w32time <span class="token punctuation">|</span> <span class="token function">Select-Object</span> <span class="token operator">-</span>Property Name<span class="token punctuation">,</span> StartType<span class="token punctuation">,</span> Status</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来查看<code>w32time</code>的配置：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line">w32tm <span class="token operator">/</span>query <span class="token operator">/</span>configuration</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>应该会在输出的<code>[TimeProviders]</code>部分看到类似下面的内容：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">NtpServer (本地)</span>
<span class="line">DllName: C:\\WINDOWS\\system32\\w32time.dll (本地)</span>
<span class="line">Enabled: 1 (本地)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="向-ntp-服务器同步时间" tabindex="-1"><a class="header-anchor" href="#向-ntp-服务器同步时间"><span>向 NTP 服务器同步时间</span></a></h2><p>首先启动<code>w32time</code>服务，并让它开机自动启动：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token function">Start-Service</span> w32time</span>
<span class="line"><span class="token function">Set-Service</span> w32time <span class="token operator">-</span>StartupType Automatic</span>
<span class="line"><span class="token function">Get-Service</span> w32time <span class="token punctuation">|</span> <span class="token function">Select-Object</span> <span class="token operator">-</span>Property Name<span class="token punctuation">,</span> StartType<span class="token punctuation">,</span> Status</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后运行下面的命令配置 NTP 客户端要向哪个服务器同步时间：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token variable">$ntpServer</span> = <span class="token string">&quot;127.0.0.1&quot;</span></span>
<span class="line">w32tm <span class="token operator">/</span>config <span class="token operator">/</span>manualpeerlist:<span class="token variable">$ntpServer</span> <span class="token operator">/</span>syncfromflags:manual <span class="token operator">/</span>reliable:yes <span class="token operator">/</span>update</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>最后运行下面的命令来强制 NTP 客户端立即同步时间：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token function">Set-Date</span> <span class="token punctuation">(</span><span class="token function">Get-Date</span><span class="token punctuation">)</span><span class="token punctuation">.</span>AddSeconds<span class="token punctuation">(</span><span class="token operator">-</span>5<span class="token punctuation">)</span> <span class="token comment"># 将本地时间提前5秒</span></span>
<span class="line">w32tm <span class="token operator">/</span>resync <span class="token operator">/</span>force</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>这里要将本地时间提前 5 秒是为了确保<code>w32time</code>立即同步时间。经过测试，<code>w32time</code>的逻辑是如果时间相差不多就不会立即同步，所以我们需要故意将本地时间弄得不准，这样才能强制同步。</p><p>可以通过下面的命令来检验同步结果：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line">w32tm <span class="token operator">/</span>stripchart <span class="token operator">/</span>computer:<span class="token variable">$ntpServer</span> <span class="token operator">/</span>samples:5</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>所看到的输出应该是类似下面这样的：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">09:16:23, d:+00.0004502s o:+00.0001461s  [                           *                           ]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>其中<code>o:</code>代表 offset，也就是本地时间和 NTP 服务器时间的差值（当然这是个估计值）。如果这个值较低，那么就说明同步成功了。</p><h2 id="关于-windows-ntp-实现的精度" tabindex="-1"><a class="header-anchor" href="#关于-windows-ntp-实现的精度"><span>关于 Windows NTP 实现的精度</span></a></h2><p>根据 Windows 官方文档，在 Windows 8 之前，Windows 的 NTP 实现并不标准，因此精度很差，只能达到秒的量级。而在 Windows 10 之后，微软改进了 NTP 服务的实现，现在的精度可以达到毫秒级别。具体可以参考以下文档：</p><ol><li><a href="https://learn.microsoft.com/en-us/windows-server/networking/windows-time-service/configuring-systems-for-high-accuracy" target="_blank" rel="noopener noreferrer">Configuring systems for high accuracy</a></li><li><a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/active-directory/support-boundary-high-accuracy-time" target="_blank" rel="noopener noreferrer">Support boundary for high-accuracy time</a>（这个文档详细描述了达到不同精度的环境要求。）</li></ol>`,31)])])}const o=e(i,[["render",l]]),c=JSON.parse('{"path":"/posts/2024/12/windows-ntp.html","title":"Windows NTP指南","lang":"zh-CN","frontmatter":{"date":"2024-12-05T00:00:00.000Z"},"headers":[{"level":2,"title":"防火墙配置","slug":"防火墙配置","link":"#防火墙配置","children":[]},{"level":2,"title":"启动 NTP 服务器","slug":"启动-ntp-服务器","link":"#启动-ntp-服务器","children":[]},{"level":2,"title":"向 NTP 服务器同步时间","slug":"向-ntp-服务器同步时间","link":"#向-ntp-服务器同步时间","children":[]},{"level":2,"title":"关于 Windows NTP 实现的精度","slug":"关于-windows-ntp-实现的精度","link":"#关于-windows-ntp-实现的精度","children":[]}],"git":{"updatedTime":1763699399000,"contributors":[{"name":"shi0rik0","username":"shi0rik0","email":"anguuan@outlook.com","commits":2,"url":"https://github.com/shi0rik0"}],"changelog":[{"hash":"35d50711ef3a591a2383977aa02873c707aa5c1e","time":1763699399000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Organize files by date"},{"hash":"27621ea60c6645dc9e44007e7ab6fd2858c37eaf","time":1763698804000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Migrate posts"}]},"filePathRelative":"posts/2024/12/windows-ntp.md","excerpt":"\\n<p>本文将介绍如何在 Windows 系统上启动 NTP 服务器，以及如何让 NTP 客户端同步时间。</p>\\n<p>注意：本文中的大部分操作都需要管理员权限。</p>\\n<h2>防火墙配置</h2>\\n<p>默认配置下，Windows 防火墙会阻止所有未经允许的入站连接。因此，我们需要允许 NTP 服务（使用 UDP 123 端口）的入站连接。</p>\\n<div class=\\"language-powershell line-numbers-mode\\" data-highlighter=\\"prismjs\\" data-ext=\\"powershell\\"><pre><code><span class=\\"line\\"><span class=\\"token function\\">New-NetFirewallRule</span> <span class=\\"token operator\\">-</span>DisplayName <span class=\\"token string\\">\\"Allow NTP\\"</span> <span class=\\"token operator\\">-</span>Direction Inbound <span class=\\"token operator\\">-</span>Protocol UDP <span class=\\"token operator\\">-</span>LocalPort 123 <span class=\\"token operator\\">-</span>Action Allow</span>\\n<span class=\\"line\\"></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div></div></div>"}');export{o as comp,c as data};
