import{_ as s,c as a,d as p,o as e}from"./app-D9VVartN.js";const t={};function o(c,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h1 id="在pybind11中操作numpy数组" tabindex="-1"><a class="header-anchor" href="#在pybind11中操作numpy数组"><span>在pybind11中操作numpy数组</span></a></h1><p>最近需要给 Python 写一个涉及 numpy 数组操作的 C++扩展。我用的是<code>pybind11</code>，用这个库写 Python C++拓展非常方便，并且这个库也提供了对于 numpy API 的封装，可惜<a href="https://pybind11.readthedocs.io/en/stable/advanced/pycpp/numpy.html" target="_blank" rel="noopener noreferrer">官方文档</a>写得比较晦涩，并且也不太全面。我结合官方文档和源代码，总结了一下 numpy 数组的操作方法。</p><h2 id="头文件" tabindex="-1"><a class="header-anchor" href="#头文件"><span>头文件</span></a></h2><p>首先要 include 以下头文件：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pybind11/buffer_info.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pybind11/numpy.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pybind11/pybind11.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">namespace</span> py <span class="token operator">=</span> pybind11<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="numpy-数组在-pybind11-中的类型" tabindex="-1"><a class="header-anchor" href="#numpy-数组在-pybind11-中的类型"><span>numpy 数组在 pybind11 中的类型</span></a></h2><p>在<code>pybind11</code>中，numpy 数组的类型是<code>py::array</code>。如果要限定数组的<code>dtype</code>，还可以用<code>py::array_t&lt;T&gt;</code>，其中<code>T</code>是数组元素的类型。例如，如果数组元素是<code>double</code>类型，那么数组的类型就是<code>py::array_t&lt;double&gt;</code>。</p><h2 id="获取-numpy-数组的信息" tabindex="-1"><a class="header-anchor" href="#获取-numpy-数组的信息"><span>获取 numpy 数组的信息</span></a></h2><p>获取 numpy 数组的信息可以使用<code>py::array_t</code>对象的<code>request()</code>方法，这个方法返回一个<code>py::buffer_info</code>对象，这个对象包含了数组的维度、元素类型、元素大小等信息。例如：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">print_array_info</span><span class="token punctuation">(</span>py<span class="token double-colon punctuation">::</span>array arr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    py<span class="token double-colon punctuation">::</span>buffer_info info <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;ndim: &quot;</span> <span class="token operator">&lt;&lt;</span> info<span class="token punctuation">.</span>ndim <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></span>
<span class="line">    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;shape: &quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> s <span class="token operator">:</span> info<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> s <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></span>
<span class="line">    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;dtype: &quot;</span> <span class="token operator">&lt;&lt;</span> info<span class="token punctuation">.</span>format <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></span>
<span class="line">    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;itemsize: &quot;</span> <span class="token operator">&lt;&lt;</span> info<span class="token punctuation">.</span>itemsize <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>假如我们这么调用这个函数：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">arr <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span></span>
<span class="line">m<span class="token punctuation">.</span>print_array_info<span class="token punctuation">(</span>arr<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>那么输出结果就是：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">ndim: 2</span>
<span class="line">shape: 3 4</span>
<span class="line">dtype: l</span>
<span class="line">itemsize: 4</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="访问、修改数组元素" tabindex="-1"><a class="header-anchor" href="#访问、修改数组元素"><span>访问、修改数组元素</span></a></h2><p>如果只是访问数组元素，可以使用<code>unchecked()</code>方法，这个方法会返回一个 proxy 对象，通过这个对象可以直接访问数组元素。例如：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">print_2d_array</span><span class="token punctuation">(</span>py<span class="token double-colon punctuation">::</span>array_t<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ndim <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">&quot;only 2D array is supported&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">auto</span> shape <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">auto</span> proxy <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">unchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token function">proxy</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果还要修改元素，就需要使用<code>mutable_unchecked()</code>。例如：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">add_one</span><span class="token punctuation">(</span>py<span class="token double-colon punctuation">::</span>array_t<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ndim <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">&quot;only 1D array is supported&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">auto</span> size <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">auto</span> proxy <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">mutable_unchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">proxy</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里还要注意，<code>py::array_t</code>是一个引用类型，在传参过程中底层数据不会被复制，所以在函数内部修改数组元素会影响到原数组。</p><p><code>unchecked()</code>和<code>mutable_unchecked()</code>方法都接受一个可选的模板参数，代表数组的维度。指定维度可以让编译器生成更高效的代码。例如：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code><span class="line"><span class="token keyword">auto</span> proxy <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">unchecked</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="创建、返回-numpy-数组" tabindex="-1"><a class="header-anchor" href="#创建、返回-numpy-数组"><span>创建、返回 numpy 数组</span></a></h2><p>如果要创建 numpy 数组，使用<code>py::array_t</code>的构造函数即可。其中一个构造函数接受数组的维度，然后返回指定维度的数组。要注意的是，返回值不会被初始化为全 0。这个构造函数的参数相当泛型，可以接受<code>std::vector</code>、<code>std::initializer_list</code>等类型。例如：</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code><span class="line">py<span class="token double-colon punctuation">::</span>array_t<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span> <span class="token function">create_array</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> py<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">array_t</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>size<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 因为是一维数组，所以也可以用 py::array_t&lt;double&gt;(size)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个例子也展示了如何返回 numpy 数组，直接 return 即可。因为<code>py::array_t</code>是一个引用类型，所以返回的过程不会发生复制。</p>`,26)])])}const i=s(t,[["render",o]]),u=JSON.parse('{"path":"/posts/2024/12/pybind11-numpy.html","title":"在pybind11中操作numpy数组","lang":"zh-CN","frontmatter":{"date":"2024-12-29T00:00:00.000Z"},"headers":[{"level":2,"title":"头文件","slug":"头文件","link":"#头文件","children":[]},{"level":2,"title":"numpy 数组在 pybind11 中的类型","slug":"numpy-数组在-pybind11-中的类型","link":"#numpy-数组在-pybind11-中的类型","children":[]},{"level":2,"title":"获取 numpy 数组的信息","slug":"获取-numpy-数组的信息","link":"#获取-numpy-数组的信息","children":[]},{"level":2,"title":"访问、修改数组元素","slug":"访问、修改数组元素","link":"#访问、修改数组元素","children":[]},{"level":2,"title":"创建、返回 numpy 数组","slug":"创建、返回-numpy-数组","link":"#创建、返回-numpy-数组","children":[]}],"git":{"updatedTime":1763699399000,"contributors":[{"name":"shi0rik0","username":"shi0rik0","email":"anguuan@outlook.com","commits":2,"url":"https://github.com/shi0rik0"}],"changelog":[{"hash":"35d50711ef3a591a2383977aa02873c707aa5c1e","time":1763699399000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Organize files by date"},{"hash":"27621ea60c6645dc9e44007e7ab6fd2858c37eaf","time":1763698804000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Migrate posts"}]},"filePathRelative":"posts/2024/12/pybind11-numpy.md","excerpt":"\\n<p>最近需要给 Python 写一个涉及 numpy 数组操作的 C++扩展。我用的是<code>pybind11</code>，用这个库写 Python C++拓展非常方便，并且这个库也提供了对于 numpy API 的封装，可惜<a href=\\"https://pybind11.readthedocs.io/en/stable/advanced/pycpp/numpy.html\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">官方文档</a>写得比较晦涩，并且也不太全面。我结合官方文档和源代码，总结了一下 numpy 数组的操作方法。</p>\\n<h2>头文件</h2>"}');export{i as comp,u as data};
