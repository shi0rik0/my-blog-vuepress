import{_ as n,c as e,d as a,o as l}from"./app-DDoPRsSr.js";const c={};function p(t,s){return l(),e("div",null,[...s[0]||(s[0]=[a(`<h1 id="docker-compose确保postgres启动的方法" tabindex="-1"><a class="header-anchor" href="#docker-compose确保postgres启动的方法"><span>Docker Compose确保Postgres启动的方法</span></a></h1><p>最近我编写了一个 Django + Postgres 的网站，其 docker-compose.yml 大概是下面这样的：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code><span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">db</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres</span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">web</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> django</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> db</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据 Docker 文档，指定<code>depends_on</code>属性可以确保 Django 容器在 Postgres 容器启动之后才启动。但是这么设置之后，会发现启动的时候 Django 还是有可能连接不上 Postgres 导致异常。其原因在于：Postgres 容器启动（也就是 Postgres 进程启动）<strong>不代表 Postgres 进程已经准备好接受连接了</strong>。这之间还需要一段时间用来初始化。因此上面的 docker-compose.yml 是不可靠的。</p><p>正确的写法应该是下面这样的：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code><span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">db</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres</span>
<span class="line">    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">test</span><span class="token punctuation">:</span> pg_isready <span class="token punctuation">|</span><span class="token punctuation">|</span> exit 1</span>
<span class="line">      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 5s</span>
<span class="line">      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s</span>
<span class="line">      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">120</span></span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">web</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> django</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">db</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">condition</span><span class="token punctuation">:</span> service_healthy</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先看<code>db</code>的<code>healthcheck</code>属性。这个属性用来启用 Docker 的 healthcheck 机制。Docker 会定期在容器内运行<code>test</code>所指定的命令，根据命令的返回值来判断容器的健康状态。<code>pg_isready</code>是 Postgres 官方提供的命令，用于检测 Postgres 是否已经完全启动。</p><p>这里有一个乍看之下比较奇怪的地方，就是在命令后面还加上了<code>|| exit 1</code>。这是因为，根据<a href="https://docs.docker.com/reference/dockerfile/#healthcheck" target="_blank" rel="noopener noreferrer">Docker 官方文档</a>，如果<code>test</code>所指定的命令的结束代码为 0，则表示容器健康；若为 1，则表示容器异常；结束代码 2 则作为保留值，不应该使用它（吐槽一下：那么除了 0、1、2 以外的结束代码呢？）。在 Shell 脚本中，<code>a || b</code>表示仅当<code>a</code>的结束代码为 0 时才执行<code>b</code>。因此当<code>pg_isready</code>返回 0 的时候，<code>pg_isready || exit 1</code>的结束代码是 0；若<code>pg_isready</code>返回非 0 的值，则<code>pg_isready || exit 1</code>会一律返回 1。这样就符合了 Docker 的约定。</p><p>然后在<code>web</code>的<code>depends_on</code>属性里加入<code>condition: service_healthy</code>，就可以让<code>web</code>容器在<code>db</code>容器处于 healthy 状态后才启动。</p>`,9)])])}const o=n(c,[["render",p]]),d=JSON.parse('{"path":"/posts/docker-healthcheck.html","title":"Docker Compose确保Postgres启动的方法","lang":"zh-CN","frontmatter":{"date":"2024-10-16T00:00:00.000Z"},"headers":[],"git":{"updatedTime":1763698804000,"contributors":[{"name":"shi0rik0","username":"shi0rik0","email":"anguuan@outlook.com","commits":1,"url":"https://github.com/shi0rik0"}],"changelog":[{"hash":"27621ea60c6645dc9e44007e7ab6fd2858c37eaf","time":1763698804000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Migrate posts"}]},"filePathRelative":"posts/docker-healthcheck.md","excerpt":"\\n<p>最近我编写了一个 Django + Postgres 的网站，其 docker-compose.yml 大概是下面这样的：</p>\\n<div class=\\"language-yaml line-numbers-mode\\" data-highlighter=\\"prismjs\\" data-ext=\\"yml\\"><pre><code><span class=\\"line\\"><span class=\\"token key atrule\\">services</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">  <span class=\\"token key atrule\\">db</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">    <span class=\\"token key atrule\\">image</span><span class=\\"token punctuation\\">:</span> postgres</span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\">  <span class=\\"token key atrule\\">web</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">    <span class=\\"token key atrule\\">image</span><span class=\\"token punctuation\\">:</span> django</span>\\n<span class=\\"line\\">    <span class=\\"token key atrule\\">depends_on</span><span class=\\"token punctuation\\">:</span></span>\\n<span class=\\"line\\">      <span class=\\"token punctuation\\">-</span> db</span>\\n<span class=\\"line\\"></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}');export{o as comp,d as data};
