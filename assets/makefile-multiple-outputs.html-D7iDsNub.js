import{_ as s,c as a,d as e,o as i}from"./app-DEX1Ewll.js";const t={};function p(l,n){return i(),a("div",null,[...n[0]||(n[0]=[e(`<h1 id="用makefile编写生成多个目标文件的规则" tabindex="-1"><a class="header-anchor" href="#用makefile编写生成多个目标文件的规则"><span>用Makefile编写生成多个目标文件的规则</span></a></h1><p>假设现在有一个命令 cmd，它会读取文件 a，然后生成文件 x 和 y。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Reading a.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;cat a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Creating x and y.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;touch x y&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可能很自然地会写出这样的 Makefile 规则：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">all: x y ;</span>
<span class="line"></span>
<span class="line">x y: a</span>
<span class="line">    cmd</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>乍一看，这似乎没问题，但是当我们并发运行 make 的时候，问题就出现了。假设我们运行<code>make -j2</code>，就会看到以下输出：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">Reading a.</span>
<span class="line">Reading a.</span>
<span class="line">Creating x and y.</span>
<span class="line">Creating x and y.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也就是说，这个命令被执行了两次！这是因为，当我们编写</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">x y: a</span>
<span class="line">    cmd</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>的时候，实际上等价于</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">x: a</span>
<span class="line">    cmd</span>
<span class="line"></span>
<span class="line">y: a</span>
<span class="line">    cmd</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样一来，当多线程运行的时候，make 就会并行地同时生成 x 和 y，导致重复执行。</p><p>后来，我在<a href="https://stackoverflow.com/questions/2973445/gnu-makefile-rule-generating-a-few-targets-from-a-single-source-file" target="_blank" rel="noopener noreferrer">这个 StackOverflow 问题</a>中找到了解决办法。</p><h2 id="gnu-make-v4-3-之后的版本" tabindex="-1"><a class="header-anchor" href="#gnu-make-v4-3-之后的版本"><span>GNU Make v4.3 之后的版本</span></a></h2><p>GNU Make v4.3 新增了 grouped explicit targets 的特性，我们只需要在冒号前面加一个&amp;就可以解决问题。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">x y &amp;: a</span>
<span class="line">    cmd</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="gnu-make-v4-3-之前的版本" tabindex="-1"><a class="header-anchor" href="#gnu-make-v4-3-之前的版本"><span>GNU Make v4.3 之前的版本</span></a></h2><p>如果需要考虑到版本兼容性，那么还有一种更通用但是更复杂的解决方法，这种方法利用了一个虚拟的中间文件 xy.intermediate。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">x y: xy.intermediate ;</span>
<span class="line"></span>
<span class="line">.INTERMEDIATE: xy.intermediate</span>
<span class="line">xy.intermediate: a</span>
<span class="line">	cmd</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了让这个方法用起来更加方便，我编写了一个 VSCode snippet：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code><span class="line"><span class="token property">&quot;Multiple outputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;prefix&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;multiout&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;body&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;\${1:&lt;TARGETS&gt;}: \${1/[^0-9a-zA-Z_\\\\-\\\\.]//g}.intermediate ;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;.INTERMEDIATE: \${1/[^0-9a-zA-Z_\\\\-\\\\.]//g}.intermediate&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;\${1/[^0-9a-zA-Z_\\\\-\\\\.]//g}.intermediate: \${2:&lt;DEPS&gt;}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;\\t&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;A pattern for recipes with multiple outputs.&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,21)])])}const o=s(t,[["render",p]]),u=JSON.parse('{"path":"/posts/2024/04/makefile-multiple-outputs.html","title":"用Makefile编写生成多个目标文件的规则","lang":"zh-CN","frontmatter":{"date":"2024-04-27T00:00:00.000Z"},"headers":[{"level":2,"title":"GNU Make v4.3 之后的版本","slug":"gnu-make-v4-3-之后的版本","link":"#gnu-make-v4-3-之后的版本","children":[]},{"level":2,"title":"GNU Make v4.3 之前的版本","slug":"gnu-make-v4-3-之前的版本","link":"#gnu-make-v4-3-之前的版本","children":[]}],"git":{"updatedTime":1763699399000,"contributors":[{"name":"shi0rik0","username":"shi0rik0","email":"anguuan@outlook.com","commits":2,"url":"https://github.com/shi0rik0"}],"changelog":[{"hash":"35d50711ef3a591a2383977aa02873c707aa5c1e","time":1763699399000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Organize files by date"},{"hash":"27621ea60c6645dc9e44007e7ab6fd2858c37eaf","time":1763698804000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Migrate posts"}]},"filePathRelative":"posts/2024/04/makefile-multiple-outputs.md","excerpt":"\\n<p>假设现在有一个命令 cmd，它会读取文件 a，然后生成文件 x 和 y。</p>\\n<div class=\\"language-c line-numbers-mode\\" data-highlighter=\\"prismjs\\" data-ext=\\"c\\"><pre><code><span class=\\"line\\"><span class=\\"token macro property\\"><span class=\\"token directive-hash\\">#</span><span class=\\"token directive keyword\\">include</span> <span class=\\"token string\\">&lt;stdio.h&gt;</span></span></span>\\n<span class=\\"line\\"><span class=\\"token macro property\\"><span class=\\"token directive-hash\\">#</span><span class=\\"token directive keyword\\">include</span> <span class=\\"token string\\">&lt;stdlib.h&gt;</span></span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span class=\\"token keyword\\">int</span> <span class=\\"token function\\">main</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span></span>\\n<span class=\\"line\\">    <span class=\\"token function\\">puts</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"Reading a.\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span></span>\\n<span class=\\"line\\">    <span class=\\"token function\\">system</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"cat a\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span></span>\\n<span class=\\"line\\">    <span class=\\"token function\\">puts</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"Creating x and y.\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span></span>\\n<span class=\\"line\\">    <span class=\\"token function\\">system</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"touch x y\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span></span>\\n<span class=\\"line\\">    <span class=\\"token keyword\\">return</span> <span class=\\"token number\\">0</span><span class=\\"token punctuation\\">;</span></span>\\n<span class=\\"line\\"><span class=\\"token punctuation\\">}</span></span>\\n<span class=\\"line\\"></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}');export{o as comp,u as data};
