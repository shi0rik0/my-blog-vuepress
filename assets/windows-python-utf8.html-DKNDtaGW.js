import{_ as s,c as a,d as e,o as t}from"./app-D9VVartN.js";const p={};function l(i,n){return t(),a("div",null,[...n[0]||(n[0]=[e(`<h1 id="windows环境下python-utf-8编码的一些坑" tabindex="-1"><a class="header-anchor" href="#windows环境下python-utf-8编码的一些坑"><span>Windows环境下Python UTF-8编码的一些坑</span></a></h1><p>众所周知，Python 3 相比 Python 2 最大的变化之一就是字符串强制使用 UTF-8 编码，但这并不意味着使用 Python 3 就不会有字符编码的问题。在 Python 的世界里，确实一切皆 UTF-8，但是一旦和操作系统交互，就可能会出现问题。</p><h2 id="open-的默认编码" tabindex="-1"><a class="header-anchor" href="#open-的默认编码"><span>open()的默认编码</span></a></h2><p>在 Unix 系统上，open()函数的默认编码是 UTF-8，但是在 Windows 系统上，open()函数的默认编码是 ANSI（也就是根据 Windows 的地区设置而定，在中文 Windows 上一般是 GBK 编码）。因此，如果在 Windows 系统上要让 open()函数使用 UTF-8 编码，就需要显式指定编码：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&#39;file.txt&#39;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="python-的-utf-8-模式" tabindex="-1"><a class="header-anchor" href="#python-的-utf-8-模式"><span>Python 的 UTF-8 模式</span></a></h2><p>在<a href="https://peps.python.org/pep-0540/" target="_blank" rel="noopener noreferrer">PEP 540</a>中，Python 引入了一个新的“UTF-8 模式”。这个模式可以通过以下两种方式启动：</p><ol><li>在环境变量中设置<code>PYTHONUTF8=1</code>。</li><li>在启动 Python 解释器时，使用<code>-X utf8</code>参数，例如：</li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">python <span class="token parameter variable">-X</span> utf8 script.py</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>启动 UTF-8 模式后，哪怕是在 Windows 系统上，open()函数也会默认使用 UTF-8 编码。</p><h2 id="sys-stdout-的编码" tabindex="-1"><a class="header-anchor" href="#sys-stdout-的编码"><span>sys.stdout 的编码</span></a></h2><p>本节将讨论 Windows 命令行输出的编码问题，下文中的命令行指的都是 PowerShell。</p><p>在 Windows 环境下，如果启动 Python 解释器的时候没有将 stdout 重定向，那么 sys.stdout 的编码是 UTF-8，否则就会是 ANSI。下面的例子就证明了这一点：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># test.py</span></span>
<span class="line"><span class="token keyword">import</span> sys</span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>encoding<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token function">PS</span>&gt; python test<span class="token punctuation">.</span>py</span>
<span class="line">utf-8</span>
<span class="line"><span class="token function">PS</span>&gt; python test<span class="token punctuation">.</span>py &gt; out<span class="token punctuation">.</span>txt</span>
<span class="line"><span class="token function">PS</span>&gt; <span class="token function">gc</span> out<span class="token punctuation">.</span>txt</span>
<span class="line">gbk</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要让 sys.stdout 的编码始终是 UTF-8，要么启用上文所提到的 UTF-8 模式，要么就要在代码中显式指定编码：</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> sys</span>
<span class="line">sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>reconfigure<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>不过，真正麻烦的地方才刚刚开始。在重定向 stdout 之后，不仅要让 Python 输出 UTF-8，还要让命令行知道输出的是 UTF-8，否则依然会出现乱码。这可以通过指定<code>Out-File</code>命令的<code>-Encoding</code>参数来实现，但这里又有一个奇怪的地方，就是要指定<code>-Encoding</code>为<code>default</code>（也就是 ANSI）才不会乱码。具体的原因我也不太清楚。</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line">python test<span class="token punctuation">.</span>py <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>Encoding default out<span class="token punctuation">.</span>txt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果觉得每次都要这样写很麻烦，也可以通过指定<code>$PSDefaultParameterValues</code>来让<code>Out-File</code>的<code>-Encoding</code>参数默认为<code>default</code>：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token variable">$PSDefaultParameterValues</span><span class="token punctuation">[</span><span class="token string">&#39;Out-File:Encoding&#39;</span><span class="token punctuation">]</span> = <span class="token string">&#39;default&#39;</span></span>
<span class="line">python test<span class="token punctuation">.</span>py <span class="token punctuation">|</span> <span class="token function">Out-File</span> out<span class="token punctuation">.</span>txt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以通过编辑<code>$PROFILE</code>文件来让这个设置永久生效：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-not</span> <span class="token punctuation">(</span><span class="token function">Test-Path</span> <span class="token variable">$PROFILE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">New-Item</span> <span class="token variable">$PROFILE</span> <span class="token operator">-</span>ItemType File <span class="token operator">-</span>Force</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">Add-Content</span> <span class="token operator">-</span>Path <span class="token variable">$PROFILE</span> <span class="token operator">-</span>Value <span class="token string">&quot;\`<span class="token variable">$PSDefaultParameterValues</span>[&#39;Out-File:Encoding&#39;] = &#39;default&#39;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里还有一个坑，就是 PowerShell 7 开始，这个<code>default</code>参数被改名成了<code>ansi</code>，所以要注意版本。不过目前 Windows 11 自带的 PowerShell 还是 5.x 版本。</p><p>这里提供一个我写的 PowerShell 函数<code>My-Out-File</code>，可以自动根据版本来设置<code>-Encoding</code>：</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code><span class="line"><span class="token keyword">function</span> My-<span class="token function">Out-File</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">param</span> <span class="token punctuation">(</span></span>
<span class="line">        <span class="token namespace">[string]</span><span class="token variable">$Path</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">        <span class="token namespace">[Parameter(ValueFromPipeline = $true)]</span></span>
<span class="line">        <span class="token namespace">[string]</span><span class="token variable">$InputString</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token variable">$version</span> = <span class="token variable">$PSVersionTable</span><span class="token punctuation">.</span>PSVersion<span class="token punctuation">.</span>Major</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$version</span> <span class="token operator">-eq</span> 5<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">Write-Output</span> <span class="token variable">$InputString</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>FilePath <span class="token variable">$Path</span> <span class="token operator">-</span>Encoding default</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$version</span> <span class="token operator">-ge</span> 7<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">Write-Output</span> <span class="token variable">$InputString</span> <span class="token punctuation">|</span> <span class="token function">Out-File</span> <span class="token operator">-</span>FilePath <span class="token variable">$Path</span> <span class="token operator">-</span>Encoding ansi</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">Write-Host</span> <span class="token string">&quot;Unsupported PowerShell version: <span class="token variable">$version</span>&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,26)])])}const c=s(p,[["render",l]]),r=JSON.parse('{"path":"/posts/2024/11/windows-python-utf8.html","title":"Windows环境下Python UTF-8编码的一些坑","lang":"zh-CN","frontmatter":{"date":"2024-11-30T00:00:00.000Z"},"headers":[{"level":2,"title":"open()的默认编码","slug":"open-的默认编码","link":"#open-的默认编码","children":[]},{"level":2,"title":"Python 的 UTF-8 模式","slug":"python-的-utf-8-模式","link":"#python-的-utf-8-模式","children":[]},{"level":2,"title":"sys.stdout 的编码","slug":"sys-stdout-的编码","link":"#sys-stdout-的编码","children":[]}],"git":{"updatedTime":1763699399000,"contributors":[{"name":"shi0rik0","username":"shi0rik0","email":"anguuan@outlook.com","commits":2,"url":"https://github.com/shi0rik0"}],"changelog":[{"hash":"35d50711ef3a591a2383977aa02873c707aa5c1e","time":1763699399000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Organize files by date"},{"hash":"27621ea60c6645dc9e44007e7ab6fd2858c37eaf","time":1763698804000,"email":"anguuan@outlook.com","author":"shi0rik0","message":"Migrate posts"}]},"filePathRelative":"posts/2024/11/windows-python-utf8.md","excerpt":"\\n<p>众所周知，Python 3 相比 Python 2 最大的变化之一就是字符串强制使用 UTF-8 编码，但这并不意味着使用 Python 3 就不会有字符编码的问题。在 Python 的世界里，确实一切皆 UTF-8，但是一旦和操作系统交互，就可能会出现问题。</p>\\n<h2>open()的默认编码</h2>\\n<p>在 Unix 系统上，open()函数的默认编码是 UTF-8，但是在 Windows 系统上，open()函数的默认编码是 ANSI（也就是根据 Windows 的地区设置而定，在中文 Windows 上一般是 GBK 编码）。因此，如果在 Windows 系统上要让 open()函数使用 UTF-8 编码，就需要显式指定编码：</p>"}');export{c as comp,r as data};
